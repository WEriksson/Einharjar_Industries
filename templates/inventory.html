<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Inventory - EVE Market Tool v2</title>
  <link rel="stylesheet" href="/static/style.css">

  <!-- Local styling just for the summary tiles -->
  <style>
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary-card {
      padding: 12px 16px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      opacity: 0.75;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.3;
      white-space: nowrap;
    }

    .summary-sub {
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    @media (max-width: 600px) {
      .summary-value {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1>Inventory</h1>
      <p>Current stock aggregated by item. Quantities are remaining units across all lots.</p>

      {% include "_nav.html" %}

    </header>

    <!-- Summary -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2>Inventory summary</h2>
          <p class="help-text">
            Totals from all inventory lots with remaining quantity.
          </p>
        </div>
      </div>

      {% if summary and summary.total_items > 0 %}
        <div class="summary-stats">
          <div class="summary-card">
            <div class="summary-label">Unique items</div>
            <div class="summary-value">{{ summary.total_items }}</div>
            <div class="summary-sub">Distinct type IDs in stock</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total units</div>
            <div class="summary-value">{{ summary.total_units }}</div>
            <div class="summary-sub">All remaining units combined</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total cost</div>
            <div class="summary-value">
              {{ summary.total_cost | isk }} ISK
            </div>
            <div class="summary-sub">Purchase cost of current stock</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total volume</div>
            <div class="summary-value">
              {{ "%.2f" | format(summary.total_volume) }} m³
            </div>
            <div class="summary-sub">For items with known volume</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total shipping</div>
            <div class="summary-value">
              {{ summary.total_shipping | isk }} ISK
            </div>
            <div class="summary-sub">Accumulated shipping cost (lots)</div>
          </div>
        </div>
      {% else %}
        <p class="help-text" style="margin-top: 8px;">
          No inventory data yet. Import some items first.
        </p>
      {% endif %}
    </section>

    <!-- Inventory table -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2>Items</h2>
          <p class="help-text">
            One row per item. Quantity and cost are aggregated from all lots. Use “View lots” to drill into per-lot data.
          </p>
        </div>
        <div>
          <label class="field-label" for="inventory-search">Search</label>
          <input
            id="inventory-search"
            type="text"
            class="input"
            placeholder="Filter by item name..."
          >
        </div>
      </div>

      <div class="table-wrapper">
        <table class="data-table" id="inventory-table">
          <thead>
            <tr>
              <th data-sort="string">Item</th>
              <th data-sort="number">Type ID</th>
              <th data-sort="number">Qty</th>
              <th data-sort="number">Avg unit cost</th>
              <th data-sort="number">Total value</th>
              <th data-sort="number">Total volume (m³)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in items %}
              {% set item = entry.item %}
              {% set qty = entry.quantity %}
              {% set total_cost = entry.total_cost %}
              {% set avg_cost = (total_cost / qty) if qty > 0 else 0 %}
              <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.eve_type_id or "-" }}</td>
                <td>{{ qty }}</td>
                <td>{{ avg_cost | isk }}</td>
                <td>{{ total_cost | isk }}</td>
                <td>
                  {% if item.volume_m3 %}
                    {{ "%.2f" | format(item.volume_m3 * qty) }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  <a href="/inventory/item/{{ item.id }}" class="nav-button nav-button--accent" style="padding:4px 12px;font-size:0.7rem;">
                    View lots
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Simple search filter
    (function () {
      const searchInput = document.getElementById('inventory-search');
      const table = document.getElementById('inventory-table');
      if (!searchInput || !table) return;

      const tbody = table.querySelector('tbody');

      searchInput.addEventListener('input', function () {
        const query = this.value.toLowerCase();
        for (const row of tbody.rows) {
          const itemCell = row.cells[0];
          const text = itemCell.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        }
      });
    })();

    // Simple sortable columns
    (function () {
      const table = document.getElementById('inventory-table');
      if (!table) return;

      const getCellValue = (row, idx) => row.cells[idx].innerText.trim();

      const isNumber = (value) => /^-?\d+(\.\d+)?$/.test(value.replace(/,/g, ''));

      const compare = (idx, type, asc) => (a, b) => {
        const va = getCellValue(asc ? a : b, idx);
        const vb = getCellValue(asc ? b : a, idx);

        if (type === 'number' && (isNumber(va) || isNumber(vb))) {
          const na = parseFloat(va.replace(/,/g, '')) || 0;
          const nb = parseFloat(vb.replace(/,/g, '')) || 0;
          return na - nb;
        }

        return va.localeCompare(vb);
      };

      const headers = table.querySelectorAll('thead th');
      headers.forEach((th, idx) => {
        let asc = true;
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr')).filter(
            (r) => r.style.display !== 'none'
          );
          const type = th.getAttribute('data-sort') || 'string';
          rows.sort(compare(idx, type, asc));
          asc = !asc;
          rows.forEach((row) => tbody.appendChild(row));
        });
      });
    })();
  </script>
</body>
</html>
